import { catchError } from "@tsed/core/utils/catchError.js";
import { isFunction } from "@tsed/core/utils/isFunction.js";
import { lazyInject, optionalLazyInject } from "../fn/lazyInject.js";
function mapOptions(args, optional = false) {
    function wrap(key, resolver) {
        return async () => {
            try {
                const { [key]: token } = await resolver();
                return { default: token };
            }
            catch (er) {
                if (!optional) {
                    throw er;
                }
                return;
            }
        };
    }
    if (isFunction(args[0])) {
        return wrap("default", args[0]);
    }
    return wrap(args[0], args[1]);
}
export function LazyInject(...args) {
    let resolver = mapOptions(args);
    return (target, propertyKey) => {
        catchError(() => Reflect.deleteProperty(target, propertyKey));
        Reflect.defineProperty(target, propertyKey, {
            async get() {
                return lazyInject(resolver);
            }
        });
    };
}
export function OptionalLazyInject(...args) {
    const resolver = mapOptions(args, true);
    return (target, propertyKey) => {
        catchError(() => Reflect.deleteProperty(target, propertyKey));
        Reflect.defineProperty(target, propertyKey, {
            async get() {
                return optionalLazyInject(resolver);
            }
        });
    };
}
