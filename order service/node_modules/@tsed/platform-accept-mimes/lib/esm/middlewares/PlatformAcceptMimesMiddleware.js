import { uniq } from "@tsed/core";
import { constant, context, injectable, ProviderType } from "@tsed/di";
import { NotAcceptable } from "@tsed/exceptions";
/**
 * @middleware
 * @platform
 */
export class PlatformAcceptMimesMiddleware {
    constructor() {
        this.acceptMimes = constant("acceptMimes", []);
    }
    $alterEndpointHandlers(handlers, operationRoute) {
        const hasAcceptMimes = operationRoute.endpoint.acceptMimes.length || this.acceptMimes.length;
        return {
            ...handlers,
            before: [hasAcceptMimes && PlatformAcceptMimesMiddleware, ...handlers.before].filter(Boolean)
        };
    }
    use() {
        const { endpoint, request } = context();
        const mimes = uniq((endpoint?.get("acceptMimes") || []).concat(this.acceptMimes));
        if (mimes.length && !request.accepts(mimes)) {
            throw new NotAcceptable(mimes.join(", "));
        }
    }
}
injectable(PlatformAcceptMimesMiddleware).type(ProviderType.MIDDLEWARE).priority(-10);
