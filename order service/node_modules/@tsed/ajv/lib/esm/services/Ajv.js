import { cleanObject } from "@tsed/core";
import { constant, inject, injectable, injector, ProviderScope } from "@tsed/di";
import { Ajv } from "ajv";
import AjvErrors from "ajv-errors";
import AjvFormats from "ajv-formats";
function getHandler(key, service) {
    if (service[key]) {
        return service[key].bind(service);
    }
}
function getKeywordProviders() {
    return injector().getProviders("ajv:keyword");
}
function bindKeywords() {
    return getKeywordProviders().map((provider) => {
        const options = provider.store.get("ajv:keyword", {});
        const service = inject(provider.token);
        return cleanObject({
            coerceTypes: "array",
            ...options,
            validate: getHandler("validate", service),
            compile: getHandler("compile", service),
            code: getHandler("code", service),
            macro: getHandler("macro", service)
        });
    });
}
function getFormatsProviders() {
    return injector().getProviders("ajv:formats");
}
function getFormats() {
    return getFormatsProviders().map((provider) => {
        const { name, options } = provider.store.get("ajv:formats", {});
        const service = inject(provider.token);
        return {
            name,
            options: {
                ...options,
                validate: service.validate.bind(service),
                compare: service.compare?.bind(service)
            }
        };
    });
}
injectable(Ajv)
    .scope(ProviderScope.SINGLETON)
    .factory(() => {
    const { errorFormatter, keywords = [], ...props } = constant("ajv") || {};
    const options = {
        verbose: false,
        coerceTypes: true,
        strict: false,
        keywords: [...keywords, ...bindKeywords()],
        discriminator: true,
        allErrors: true,
        ...props
    };
    // @ts-ignore
    const ajv = new Ajv(options);
    // add support for custom error messages
    // @ts-ignore
    AjvErrors(ajv);
    // @ts-ignore
    AjvFormats(ajv);
    getFormats().forEach(({ name, options }) => {
        ajv.addFormat(name, options);
    });
    return ajv;
});
