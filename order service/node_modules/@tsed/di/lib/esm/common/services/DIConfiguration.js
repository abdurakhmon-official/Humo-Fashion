import { getValue } from "@tsed/core/utils/getValue.js";
import { isFunction } from "@tsed/core/utils/isFunction.js";
import { setValue } from "@tsed/core/utils/setValue.js";
import { $alter } from "@tsed/hooks";
export class DIConfiguration {
    constructor(initialProps = {}) {
        this.default = new Map();
        this.map = new Map();
        Object.entries({
            imports: [],
            routes: [],
            mount: {},
            logger: {},
            ...initialProps
        }).forEach(([key, value]) => {
            this.default.set(key, value);
        });
    }
    get version() {
        return this.get("version");
    }
    set version(v) {
        this.map.set("version", v);
    }
    get rootDir() {
        return this.get("rootDir");
    }
    set rootDir(value) {
        this.map.set("rootDir", value);
    }
    get env() {
        return this.map.get("env");
    }
    set env(value) {
        this.map.set("env", value);
    }
    get imports() {
        return this.get("imports");
    }
    set imports(imports) {
        this.map.set("imports", imports);
    }
    get routes() {
        return this.get("routes");
    }
    set routes(routes) {
        this.map.set("routes", routes);
    }
    get logger() {
        return this.get("logger");
    }
    set logger(value) {
        const logger = { ...this.logger, ...value };
        this.map.set("logger", logger);
    }
    get debug() {
        return this.logger.level === "debug";
    }
    set debug(debug) {
        this.logger = { ...this.logger, level: debug ? "debug" : "info" };
    }
    get mount() {
        return this.get("mount");
    }
    set mount(value) {
        this.setRaw("mount", value);
    }
    /**
     *
     * @param callbackfn
     * @param thisArg
     */
    forEach(callbackfn, thisArg) {
        return new Set([...Array.from(this.default.keys()), ...Array.from(this.map.keys())]).forEach((key) => {
            callbackfn(this.getRaw(key), key, this.map);
        }, thisArg);
    }
    set(propertyKey, value) {
        if (typeof propertyKey === "string") {
            value = $alter(`$alterConfig:${propertyKey}`, value);
            if (Reflect.has(this, propertyKey)) {
                // @ts-ignore
                this[propertyKey] = value;
            }
            else {
                this.setRaw(propertyKey, value);
            }
        }
        else {
            Object.entries(propertyKey).forEach(([key, value]) => {
                this.set(key, value);
            });
        }
        return this;
    }
    setRaw(propertyKey, value) {
        setValue(this.map, propertyKey, value);
        return this;
    }
    /**
     *
     * @param propertyKey
     * @param defaultValue
     * @returns {undefined|any}
     */
    get(propertyKey, defaultValue) {
        return this.getRaw(propertyKey, defaultValue);
    }
    decorate(key, value) {
        if (key in this) {
            return this;
        }
        Object.defineProperty(DIConfiguration.prototype, key, isFunction(value)
            ? {
                value
            }
            : value);
    }
    getRaw(propertyKey, defaultValue) {
        const value = getValue(this.map, propertyKey);
        if (value !== undefined) {
            return value;
        }
        return getValue(this.default, propertyKey, defaultValue);
    }
}
