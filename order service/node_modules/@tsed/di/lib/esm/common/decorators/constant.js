import { catchError } from "@tsed/core/utils/catchError.js";
import { deepClone } from "@tsed/core/utils/deepClone.js";
import { constant } from "../fn/constant.js";
export function bindConstant(target, propertyKey, expression, defaultValue) {
    const symbol = Symbol();
    catchError(() => Reflect.deleteProperty(target, propertyKey));
    Reflect.defineProperty(target, propertyKey, {
        get() {
            if (this[symbol] !== undefined) {
                return this[symbol];
            }
            const value = constant(expression, defaultValue);
            this[symbol] = Object.freeze(deepClone(value));
            return this[symbol];
        },
        set(value) {
            const bean = constant(expression, defaultValue) || this[symbol];
            if (bean === undefined && value !== undefined) {
                this[symbol] = value;
            }
        },
        enumerable: true,
        configurable: true
    });
}
/**
 * Return value from Configuration.
 *
 * ## Example
 *
 * ```typescript
 * import {Env} from "@tsed/core/domain/Env.js";
 * import {Constant, Value} from "@tsed/di";
 *
 * export class MyClass {
 *
 *    @Constant("env")
 *    env: Env;
 *
 *    @Value("swagger.path")
 *    swaggerPath: string;
 *
 *    @Value("swagger.path", "defaultValue")
 *    swaggerPath: string;
 *
 *    constructor() {
 *       console.log(this.swaggerPath) // undefined. Not available on constructor
 *    }
 *
 *    $onInit() {
 *      console.log(this.swaggerPath)  // something
 *    }
 * }
 * ```
 *
 * @param {string} expression
 * @param defaultValue
 * @returns {(targetClass: any, attributeName: string) => any}
 * @decorator
 */
export function Constant(expression, defaultValue) {
    return (target, propertyKey) => {
        return bindConstant(target, propertyKey, expression, defaultValue);
    };
}
